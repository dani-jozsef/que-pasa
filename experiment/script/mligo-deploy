#!/usr/bin/env bash
cd $(git rev-parse --show-toplevel)/experiment

set -u

contract=$1  # .mligo basename
storage=$2
logfile=log/deploy_$contract.log

./script/mligo-compile $contract || exit 1
./script/tz-cli originate contract $contract transferring 0 from alice running ./input/compiled/$contract.tz --init "$storage" --burn-cap 10 > $logfile || exit 1

c_addr=`grep -E '^New contract ' $logfile | awk -F' ' '{print $3}'`
http :$RPC_PORT/chains/main/blocks/head/context/contracts/$c_addr/script | jq '.' > output/${contract}.script || exit 1
echo "$c_addr" > output/${contract}.address
mkdir output/${contract}
echo "$c_addr"
