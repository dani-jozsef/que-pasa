#!/usr/bin/env bash
cd $(git rev-parse --show-toplevel)/experiment

set -a
. .env
set +a

tz=`./script/local-tz`
trap "docker kill $tz" EXIT
echo "waiting for private tezos network to become reachable..."
while ! http --quiet :$RPC_PORT/chains/main/blocks/head 2>/dev/null; do
    echo "private tezos network not yet reachable.."
    sleep 1
done

./script/tz-cli config reset || exit 1
./script/tz-cli bootstrapped || exit 1
./script/tz-cli config update || exit 1

rm -r output/*

bigmap_dest_addr=`./script/mligo-deploy bigmap_dest '{}'`
./script/contract-blocks $bigmap_dest_addr | while read block; do
    ./script/result-add bigmap_dest "`echo $block | jq '.'`"
done
